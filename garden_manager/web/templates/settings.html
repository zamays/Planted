{% extends "base.html" %}

{% block title %}Account Settings - Planted{% endblock %}

{% block content %}
<div class="page-header">
    <h2 class="page-title">‚öôÔ∏è Account Settings</h2>
</div>

<div class="card">
    <div class="card-header">
        üìç Location Settings
    </div>
    <div class="card-body">
        <p style="color: var(--text-gray); margin-bottom: 1rem;">
            Your location is used to provide accurate weather information and seasonal plant recommendations
            for your climate zone.
        </p>

        <form method="POST" style="margin-bottom: 1rem;">
            <input type="hidden" name="form_type" value="location">

            <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 1rem;">
                <div>
                    <label for="latitude" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                        Latitude:
                    </label>
                    <input
                        type="text"
                        id="latitude"
                        name="latitude"
                        value="{% if user and user.location %}{{ user.location.latitude }}{% endif %}"
                        placeholder="40.7128"
                        required
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
                </div>

                <div>
                    <label for="longitude" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                        Longitude:
                    </label>
                    <input
                        type="text"
                        id="longitude"
                        name="longitude"
                        value="{% if user and user.location %}{{ user.location.longitude }}{% endif %}"
                        placeholder="-74.0060"
                        required
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
                </div>
            </div>

            <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 1rem;">
                <div>
                    <label for="city" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                        City:
                    </label>
                    <input
                        type="text"
                        id="city"
                        name="city"
                        value="{% if user and user.location %}{{ user.location.city }}{% endif %}"
                        placeholder="New York"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
                </div>

                <div>
                    <label for="region" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                        State/Region:
                    </label>
                    <input
                        type="text"
                        id="region"
                        name="region"
                        value="{% if user and user.location %}{{ user.location.region }}{% endif %}"
                        placeholder="New York"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
                </div>

                <div>
                    <label for="country" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                        Country:
                    </label>
                    <input
                        type="text"
                        id="country"
                        name="country"
                        value="{% if user and user.location %}{{ user.location.country }}{% endif %}"
                        placeholder="United States"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
                </div>
            </div>

            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button type="submit" class="btn">
                    üíæ Save Location
                </button>
                <button type="button" class="btn btn-secondary" id="auto-detect-btn">
                    üåç Auto-Detect Location
                </button>
            </div>
        </form>

        <div id="location-status" style="margin-top: 1rem;"></div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        üîí Change Password
    </div>
    <div class="card-body">
        <form method="POST">
            <input type="hidden" name="form_type" value="password">

            <div style="margin-bottom: 1rem;">
                <label for="current_password" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                    Current Password:
                </label>
                <input
                    type="password"
                    id="current_password"
                    name="current_password"
                    required
                    style="width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="new_password" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                    New Password:
                </label>
                <input
                    type="password"
                    id="new_password"
                    name="new_password"
                    required
                    minlength="6"
                    style="width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
                <small style="color: var(--text-gray); display: block; margin-top: 0.25rem;">
                    Minimum 6 characters
                </small>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="confirm_password" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                    Confirm New Password:
                </label>
                <input
                    type="password"
                    id="confirm_password"
                    name="confirm_password"
                    required
                    minlength="6"
                    style="width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
            </div>

            <button type="submit" class="btn">
                üîë Change Password
            </button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        ‚úâÔ∏è Change Email Address
    </div>
    <div class="card-body">
        <p style="color: var(--text-gray); margin-bottom: 1rem;">
            Current Email: <strong>{{ user.email if user else 'Not available' }}</strong>
        </p>

        <form method="POST">
            <input type="hidden" name="form_type" value="email">

            <div style="margin-bottom: 1rem;">
                <label for="email" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                    New Email Address:
                </label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    style="width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid var(--border-gray); border-radius: 4px;">
            </div>

            <button type="submit" class="btn">
                üìß Update Email
            </button>
        </form>
    </div>
</div>

<script>
document.getElementById('auto-detect-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('location-status');

    // Disable button and show loading
    btn.disabled = true;
    btn.textContent = '‚è≥ Detecting...';
    statusDiv.innerHTML = '<p style="color: var(--text-gray);">Detecting your location...</p>';

    try {
        const response = await fetch('{{ url_for("detect_location") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.status === 'success' && data.location) {
            // Update form fields
            document.getElementById('latitude').value = data.location.latitude || '';
            document.getElementById('longitude').value = data.location.longitude || '';
            document.getElementById('city').value = data.location.city || '';
            document.getElementById('region').value = data.location.region || '';
            document.getElementById('country').value = data.location.country || '';

            statusDiv.innerHTML = '<div style="padding: 1rem; background-color: #d1fae5; border: 1px solid #10b981; border-radius: 4px; color: #065f46;">‚úÖ Location detected successfully! Click "Save Location" to apply changes.</div>';
        } else {
            statusDiv.innerHTML = '<div style="padding: 1rem; background-color: #fee2e2; border: 1px solid #ef4444; border-radius: 4px; color: #991b1b;">‚ùå ' + (data.message || 'Could not detect location') + '</div>';
        }
    } catch (error) {
        statusDiv.innerHTML = '<div style="padding: 1rem; background-color: #fee2e2; border: 1px solid #ef4444; border-radius: 4px; color: #991b1b;">‚ùå Error: ' + error.message + '</div>';
    } finally {
        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'üåç Auto-Detect Location';
    }
});
</script>
{% endblock %}
