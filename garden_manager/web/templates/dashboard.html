{% extends "base.html" %}

{% block title %}Dashboard - Planted{% endblock %}

{% block content %}
<div class="page-header">
    <h2 class="page-title">ğŸ¡ Garden Dashboard</h2>
    <div class="page-actions">
        <a href="{{ url_for('plants') }}" class="btn btn-small" title="Browse plant catalog">
            ğŸŒ¿ Browse Plants
        </a>
        <a href="{{ url_for('create_plot') }}" class="btn btn-secondary btn-small" title="Create new garden plot">
            â• New Plot
        </a>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">ğŸ—‚ï¸</div>
        <div class="stat-value">{{ stats.plots }}</div>
        <div class="stat-label">Garden Plots</div>
        <div style="margin-top: 1rem;">
            {% if stats.plots == 0 %}
            <a href="{{ url_for('create_plot') }}" class="btn btn-small" style="font-size: 0.8rem;">
                Create First Plot
            </a>
            {% else %}
            <a href="{{ url_for('garden_layout') }}" class="btn btn-small" style="font-size: 0.8rem;">
                View Plots
            </a>
            {% endif %}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸŒ±</div>
        <div class="stat-value">{{ stats.active_plants }}</div>
        <div class="stat-label">Active Plants</div>
        {% if stats.active_plants == 0 and stats.plots > 0 %}
        <div style="margin-top: 1rem;">
            <a href="{{ url_for('garden_layout') }}" class="btn btn-small" style="font-size: 0.8rem;">
                Add Plants
            </a>
        </div>
        {% endif %}
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ“‹</div>
        <div class="stat-value">{{ stats.tasks_due }}</div>
        <div class="stat-label">Tasks Due</div>
        {% if stats.tasks_due > 0 %}
        <div style="margin-top: 1rem;">
            <a href="{{ url_for('care_schedule') }}" class="btn btn-danger btn-small" style="font-size: 0.8rem;">
                View Tasks
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% if weather %}
<div class="card">
    <div class="card-header">
        ğŸŒ¦ï¸ Current Weather Conditions
    </div>
    <div class="card-body">
        <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
            <div style="font-size: 3rem;" role="img" aria-label="Weather icon">
                {% if 'clear' in weather.description or 'sunny' in weather.description %}â˜€ï¸
                {% elif 'cloud' in weather.description %}â˜ï¸
                {% elif 'rain' in weather.description %}ğŸŒ§ï¸
                {% else %}ğŸŒ¤ï¸{% endif %}
            </div>
            <div style="flex: 1;">
                <div style="font-size: 2rem; font-weight: 600; color: var(--primary-green);">
                    {{ weather.temperature }}Â°F
                </div>
                <div style="color: var(--text-gray); font-size: 1.1rem;">
                    {{ weather.description.title() }}
                </div>
                <div style="color: var(--text-gray); font-size: 0.95rem; margin-top: 0.5rem;">
                    ğŸ’§ Humidity: {{ weather.humidity }}%
                </div>
            </div>
            <div>
                <a href="{{ url_for('weather') }}" class="btn btn-secondary btn-small">
                    View Forecast â†’
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        ğŸŒ± Welcome to Planted!
    </div>
    <div class="card-body">
        <h3 style="color: var(--primary-green); margin-bottom: 1rem; font-size: 1.25rem;">
            Getting Started:
        </h3>
        <ul style="margin-left: 1.5rem; margin-bottom: 1.5rem; line-height: 1.8;">
            <li>
                <strong>Browse Plants:</strong> Discover 20+ plants with seasonal recommendations for your climate zone
            </li>
            <li>
                <strong>Create Gardens:</strong> Design your garden plots with our square-foot gardening system
            </li>
            <li>
                <strong>Track Care:</strong> Get automated watering, fertilizing, and harvest reminders
            </li>
            <li>
                <strong>Monitor Weather:</strong> Weather-based recommendations help optimize your garden care
            </li>
        </ul>
        
        <div class="alert alert-info" style="margin-bottom: 1.5rem;">
            <span style="font-size: 1.5rem;">ğŸ’¡</span>
            <div>
                <strong>Pro Tip:</strong> Start by browsing plants suited to your {{ season }} season and climate zone. 
                Then create a garden plot and start planning your layout!
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="{{ url_for('plants') }}" class="btn">
                ğŸŒ¿ Browse Plants
            </a>
            <a href="{{ url_for('create_plot') }}" class="btn btn-secondary">
                ğŸ—‚ï¸ Create Garden Plot
            </a>
            <a href="{{ url_for('care_schedule') }}" class="btn btn-secondary">
                ğŸ“… View Care Schedule
            </a>
        </div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="card">
    <div class="card-header">
        âš¡ Quick Actions
    </div>
    <div class="card-body">
        <div class="action-grid">
            <a href="{{ url_for('plants') }}" class="action-card">
                <span class="action-card-icon">ğŸ”</span>
                <span class="action-card-label">Search Plants</span>
            </a>
            <a href="{{ url_for('garden_layout') }}" class="action-card">
                <span class="action-card-icon">ğŸ—ºï¸</span>
                <span class="action-card-label">View Gardens</span>
            </a>
            <a href="{{ url_for('add_plant') }}" class="action-card">
                <span class="action-card-icon">â•</span>
                <span class="action-card-label">Add Custom Plant</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-detect location for new users who haven't set their location yet
    (function() {
        // Only run for logged-in users (not guests) who don't have a location set
        const isGuest = {{ 'true' if session.get('is_guest') else 'false' }};
        const hasLocation = {{ 'true' if user_has_location else 'false' }};
        
        if (!isGuest && !hasLocation && navigator.geolocation) {
            // Check if user has already been prompted (use sessionStorage to avoid repeated prompts)
            if (!sessionStorage.getItem('location_prompt_shown')) {
                sessionStorage.setItem('location_prompt_shown', 'true');
                
                // Show a friendly notification
                if (confirm('ğŸ“ Would you like to automatically detect your location for personalized weather and plant recommendations?\n\nYou can also set this later in Account Settings.')) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            fetch('{{ url_for("update_location") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                                },
                                body: JSON.stringify({
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('âœ… Location detected successfully! The page will refresh to show personalized recommendations.');
                                    window.location.reload();
                                }
                            })
                            .catch(error => {
                                console.error('Error saving location:', error);
                            });
                        },
                        function(error) {
                            console.log('Location detection declined or failed:', error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                }
            }
        }
    })();
</script>
{% endblock %}