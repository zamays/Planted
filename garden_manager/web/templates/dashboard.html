{% extends "base.html" %}

{% block title %}Dashboard - Planted{% endblock %}

{% block content %}
<div class="page-header">
    <h2 class="page-title">ğŸ¡ Garden Dashboard</h2>
    <div class="page-actions">
        <a href="{{ url_for('plants.index') }}" class="btn btn-small" title="Browse plant catalog">
            ğŸŒ¿ Browse Plants
        </a>
        <a href="{{ url_for('garden.create') }}" class="btn btn-secondary btn-small" title="Create new garden plot">
            â• New Plot
        </a>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">ğŸ—‚ï¸</div>
        <div class="stat-value">{{ stats.plots }}</div>
        <div class="stat-label">Garden Plots</div>
        <div style="margin-top: 1rem;">
            {% if stats.plots == 0 %}
            <a href="{{ url_for('garden.create') }}" class="btn btn-small" style="font-size: 0.8rem;">
                Create First Plot
            </a>
            {% else %}
            <a href="{{ url_for('garden.index') }}" class="btn btn-small" style="font-size: 0.8rem;">
                View Plots
            </a>
            {% endif %}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸŒ±</div>
        <div class="stat-value">{{ stats.active_plants }}</div>
        <div class="stat-label">Active Plants</div>
        {% if stats.active_plants == 0 and stats.plots > 0 %}
        <div style="margin-top: 1rem;">
            <a href="{{ url_for('garden.index') }}" class="btn btn-small" style="font-size: 0.8rem;">
                Add Plants
            </a>
        </div>
        {% endif %}
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ“‹</div>
        <div class="stat-value">{{ stats.tasks_due }}</div>
        <div class="stat-label">Tasks Due</div>
        {% if stats.tasks_due > 0 %}
        <div style="margin-top: 1rem;">
            <a href="{{ url_for('care.index') }}" class="btn btn-danger btn-small" style="font-size: 0.8rem;">
                View Tasks
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% if weather %}
<div class="card">
    <div class="card-header">
        ğŸŒ¦ï¸ Current Weather Conditions
        {% if is_default_location %}
        <span style="background: #FFF3CD; color: #856404; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; font-weight: normal;">
            Default location
        </span>
        {% endif %}
    </div>
    <div class="card-body">
        {% if is_default_location %}
        <div style="background: #FFF3CD; color: #856404; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem;">
            ğŸ“ Showing weather for <strong>{{ location }}</strong> (default).
            <a href="{{ url_for('auth.settings') }}" style="color: #856404; text-decoration: underline;">Set your location</a>
            for personalized weather and plant recommendations.
        </div>
        {% endif %}
        <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
            <div style="font-size: 3rem;" role="img" aria-label="Weather icon">
                {% if 'clear' in weather.description or 'sunny' in weather.description %}â˜€ï¸
                {% elif 'cloud' in weather.description %}â˜ï¸
                {% elif 'rain' in weather.description %}ğŸŒ§ï¸
                {% else %}ğŸŒ¤ï¸{% endif %}
            </div>
            <div style="flex: 1;">
                <div style="font-size: 2rem; font-weight: 600; color: var(--primary-green);">
                    {{ weather.temperature }}Â°F
                </div>
                <div style="color: var(--text-gray); font-size: 1.1rem;">
                    {{ weather.description.title() }}
                </div>
                <div style="color: var(--text-gray); font-size: 0.95rem; margin-top: 0.5rem;">
                    ğŸ’§ Humidity: {{ weather.humidity }}%
                </div>
            </div>
            <div>
                <a href="{{ url_for('main.weather') }}" class="btn btn-secondary btn-small">
                    View Forecast â†’
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        ğŸŒ± Welcome to Planted!
    </div>
    <div class="card-body">
        <h3 style="color: var(--primary-green); margin-bottom: 1rem; font-size: 1.25rem;">
            Getting Started:
        </h3>
        <ul style="margin-left: 1.5rem; margin-bottom: 1.5rem; line-height: 1.8;">
            <li>
                <strong>Browse Plants:</strong> Discover 20+ plants with seasonal recommendations for your climate zone
            </li>
            <li>
                <strong>Create Gardens:</strong> Design your garden plots with our square-foot gardening system
            </li>
            <li>
                <strong>Track Care:</strong> Get automated watering, fertilizing, and harvest reminders
            </li>
            <li>
                <strong>Monitor Weather:</strong> Weather-based recommendations help optimize your garden care
            </li>
        </ul>
        
        <div class="alert alert-info" style="margin-bottom: 1.5rem;">
            <span style="font-size: 1.5rem;">ğŸ’¡</span>
            <div>
                <strong>Pro Tip:</strong> Start by browsing plants suited to your {{ season }} season and climate zone. 
                Then create a garden plot and start planning your layout!
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="{{ url_for('plants.index') }}" class="btn">
                ğŸŒ¿ Browse Plants
            </a>
            <a href="{{ url_for('garden.create') }}" class="btn btn-secondary">
                ğŸ—‚ï¸ Create Garden Plot
            </a>
            <a href="{{ url_for('care.index') }}" class="btn btn-secondary">
                ğŸ“… View Care Schedule
            </a>
        </div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="card">
    <div class="card-header">
        âš¡ Quick Actions
    </div>
    <div class="card-body">
        <div class="action-grid">
            <a href="{{ url_for('plants.index') }}" class="action-card">
                <span class="action-card-icon">ğŸ”</span>
                <span class="action-card-label">Search Plants</span>
            </a>
            <a href="{{ url_for('garden.index') }}" class="action-card">
                <span class="action-card-icon">ğŸ—ºï¸</span>
                <span class="action-card-label">View Gardens</span>
            </a>
            <a href="{{ url_for('plants.add') }}" class="action-card">
                <span class="action-card-icon">â•</span>
                <span class="action-card-label">Add Custom Plant</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-detect location for new users who haven't set their location yet
    (function() {
        // Only run for logged-in users (not guests) who don't have a location set
        const isGuest = {{ 'true' if session.get('is_guest') else 'false' }};
        const hasLocation = {{ 'true' if user_has_location else 'false' }};

        if (!isGuest && !hasLocation && navigator.geolocation) {
            // Check if user has already been prompted (use sessionStorage to avoid repeated prompts)
            if (!sessionStorage.getItem('location_prompt_shown')) {
                sessionStorage.setItem('location_prompt_shown', 'true');

                // Show a friendly notification
                if (confirm('ğŸ“ Would you like to automatically detect your location for personalized weather and plant recommendations?\n\nYou can also set this later in Account Settings.')) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            fetch('{{ url_for("api.update_location") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                                },
                                body: JSON.stringify({
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // Check if there's a warning (geocoding failed)
                                    if (data.warning) {
                                        alert('âš ï¸ ' + data.warning);
                                        window.location.href = '{{ url_for("auth.settings") }}';
                                        return;
                                    }
                                    // Get the detected location from response or show generic message
                                    const locationName = data.location || 'your area';
                                    if (confirm('âœ… We detected your location as ' + locationName + '.\n\nIs this correct?\n\nClick OK to save, or Cancel to set manually in Settings.')) {
                                        window.location.reload();
                                    } else {
                                        // User wants to set manually - redirect to settings
                                        window.location.href = '{{ url_for("auth.settings") }}';
                                    }
                                } else {
                                    alert('âŒ Could not save location: ' + (data.message || 'Unknown error') + '\n\nYou can set your location manually in Account Settings.');
                                }
                            })
                            .catch(error => {
                                console.error('Error saving location:', error);
                                alert('âŒ Error communicating with server.\n\nYou can set your location manually in Account Settings.');
                            });
                        },
                        function(error) {
                            let errorMsg = '';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMsg = 'Location access was denied.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMsg = 'Location information is unavailable.';
                                    break;
                                case error.TIMEOUT:
                                    errorMsg = 'Location request timed out.';
                                    break;
                                default:
                                    errorMsg = 'An unknown error occurred.';
                            }
                            console.log('Location detection failed:', errorMsg);
                            // Don't show alert for permission denied - user chose not to share
                            if (error.code !== error.PERMISSION_DENIED) {
                                alert('âŒ ' + errorMsg + '\n\nYou can set your location manually in Account Settings.');
                            }
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                }
            }
        }
    })();
</script>
{% endblock %}