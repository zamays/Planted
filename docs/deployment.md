# Deploying Planted to the Web

This guide will help you deploy Planted to a web server for public or private access.

## Prerequisites

- A server or cloud hosting account (e.g., Render.com, DigitalOcean, AWS, Heroku, PythonAnywhere)
- Basic knowledge of Linux/Unix commands
- OpenWeatherMap API key (optional but recommended)

## Deployment Options

### Option 1: Render.com (Recommended - Free Tier Available)

Render.com offers a free tier with automatic deployments from GitHub. Planted includes a pre-configured `render.yaml` file for easy deployment.

1. **Create Account**: Sign up at [render.com](https://render.com)

2. **Connect GitHub Repository**:
   - Go to the Render Dashboard
   - Click "New +" and select "Blueprint"
   - Connect your GitHub account and select the Planted repository
   - Render will automatically detect the `render.yaml` file

3. **Configure Environment Variables** (Optional):
   - `OPENWEATHERMAP_API_KEY`: Your weather API key (app works without it)
   - `FLASK_SECRET_KEY`: Automatically generated by Render
   - `PORT`: Automatically set by Render

4. **Deploy**:
   - Click "Apply" to create the service
   - Render will automatically build and deploy the application
   - The app will be available at `https://your-app-name.onrender.com`

5. **Automatic Updates**:
   - Any push to the main branch will trigger automatic deployment
   - The free tier may sleep after 15 minutes of inactivity

**Note**: The free tier has some limitations:
- Services sleep after 15 minutes of inactivity (50ms cold start)
- 750 hours per month of running time
- Databases are ephemeral (data resets on each deploy)

### Option 2: PythonAnywhere (Easiest)

PythonAnywhere is a Python-focused hosting platform with a free tier.

1. **Create Account**: Sign up at [pythonanywhere.com](https://www.pythonanywhere.com)

2. **Upload Code**:
   ```bash
   # On PythonAnywhere console
   git clone https://github.com/zamays/Planted.git
   cd Planted
   ```

3. **Install Dependencies**:
   ```bash
   pip3 install --user -r requirements.txt
   ```

4. **Configure Web App**:
   - Go to Web tab
   - Add a new web app
   - Choose Flask
   - Set path to `/home/yourusername/Planted/app.py`

5. **Set Environment Variables**:
   - Edit your `.env` file with your API keys
   - Or use PythonAnywhere's environment variable settings

6. **Reload**: Click "Reload" on the Web tab

### Option 3: Heroku

Heroku is a cloud platform that supports Python applications.

1. **Install Heroku CLI**:
   ```bash
   # See: https://devcenter.heroku.com/articles/heroku-cli
   ```

2. **Create Heroku App**:
   ```bash
   heroku create planted-app
   ```

3. **Add Procfile**:
   Create a file named `Procfile` in the project root:
   ```
   web: gunicorn app:app
   ```

4. **Add Gunicorn**:
   Add to `requirements.txt`:
   ```
   gunicorn>=20.1.0
   ```

5. **Configure Environment**:
   ```bash
   heroku config:set OPENWEATHERMAP_API_KEY=your_key_here
   heroku config:set FLASK_SECRET_KEY=your_secret_key_here
   ```

6. **Deploy**:
   ```bash
   git push heroku main
   ```

### Option 4: DigitalOcean/AWS/Your Own Server

For more control, deploy on your own server.

#### 1. Server Setup

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Python and dependencies
sudo apt install python3 python3-pip python3-venv nginx -y
```

#### 2. Clone and Setup Application

```bash
# Clone repository
cd /var/www
sudo git clone https://github.com/zamays/Planted.git
cd Planted

# Create virtual environment
python3 -m venv venv
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt
pip install gunicorn
```

#### 3. Configure Environment

```bash
# Create .env file
sudo nano .env

# Add your configuration:
OPENWEATHERMAP_API_KEY=your_key_here
FLASK_SECRET_KEY=your_secret_key_here
```

#### 4. Create Systemd Service

Create `/etc/systemd/system/planted.service`:

```ini
[Unit]
Description=Planted Garden Management Application
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/Planted
Environment="PATH=/var/www/Planted/venv/bin"
ExecStart=/var/www/Planted/venv/bin/gunicorn --workers 3 --bind unix:planted.sock -m 007 app:app

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl enable planted
sudo systemctl start planted
sudo systemctl status planted
```

#### 5. Configure Nginx

Create `/etc/nginx/sites-available/planted`:

```nginx
server {
    listen 80;
    server_name your_domain.com;

    location / {
        include proxy_params;
        proxy_pass http://unix:/var/www/Planted/planted.sock;
    }

    location /static {
        alias /var/www/Planted/garden_manager/web/static;
    }
}
```

Enable site:
```bash
sudo ln -s /etc/nginx/sites-available/planted /etc/nginx/sites-enabled
sudo nginx -t
sudo systemctl restart nginx
```

#### 6. Setup SSL (Optional but Recommended)

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your_domain.com
```

## Production Configuration

### Security

#### 1. Secret Key Management (CRITICAL)

The Flask secret key is used for session management, CSRF protection, and secure cookie signing. A weak or compromised secret key can lead to:
- Session hijacking
- Cookie tampering
- CSRF token prediction
- Complete application compromise

**Generate a Secure Secret Key:**

```bash
# Generate a cryptographically secure 64-character hex string
python3 -c "import secrets; print(secrets.token_hex(32))"
```

**Configuration:**

The application **requires** a secure secret key to be set in your `.env` file:

```bash
# In your .env file
FLASK_SECRET_KEY=your_generated_secure_key_here
```

**Security Requirements:**
- The secret key **must** be at least 32 characters long
- The secret key **must not** be a known placeholder value (like `your_secret_key_here` or `change_this`)
- The secret key **must** be kept secret and never committed to version control
- Each environment (development, staging, production) should use a different secret key

**Important Notes:**
- The application will refuse to start if no secret key is set
- The application will refuse to start if a weak/placeholder key is detected
- The application will refuse to start if the key is less than 32 characters
- The `.env` file is already in `.gitignore` to prevent accidental commits

**Environment-Specific Secret Management:**

For production deployments, consider using environment-specific secret management services:

- **AWS Secrets Manager**: Store secrets in AWS and retrieve them at runtime
  ```bash
  # Install AWS SDK
  pip install boto3
  
  # In your deployment script
  export FLASK_SECRET_KEY=$(aws secretsmanager get-secret-value \
    --secret-id planted/flask-secret-key \
    --query SecretString --output text)
  ```

- **Azure Key Vault**: Store secrets in Azure
  ```bash
  # Install Azure SDK
  pip install azure-keyvault-secrets azure-identity
  
  # Retrieve secret at runtime (add to app.py or startup script)
  from azure.keyvault.secrets import SecretClient
  from azure.identity import DefaultAzureCredential
  
  client = SecretClient(vault_url="https://your-vault.vault.azure.net", 
                        credential=DefaultAzureCredential())
  secret = client.get_secret("flask-secret-key")
  os.environ["FLASK_SECRET_KEY"] = secret.value
  ```

- **HashiCorp Vault**: Enterprise secret management
  ```bash
  # Using Vault CLI
  export FLASK_SECRET_KEY=$(vault kv get -field=value secret/planted/flask-secret-key)
  ```

- **Render.com/Heroku**: Use platform environment variables
  ```bash
  # Render.com
  # Go to Dashboard > Environment > Add Environment Variable
  # Key: FLASK_SECRET_KEY
  # Value: (paste your generated key)
  
  # Heroku
  heroku config:set FLASK_SECRET_KEY=your_generated_key_here
  ```

**Secret Key Rotation:**

Periodically rotate your secret keys for enhanced security:

1. Generate a new secret key
2. Update your environment configuration
3. Restart the application
4. Note: This will invalidate all existing user sessions

**Security Checklist:**
- âœ… Generated a cryptographically secure secret key (at least 64 characters recommended)
- âœ… Stored the key in `.env` file (not committed to git)
- âœ… Used environment-specific keys (different for dev/staging/production)
- âœ… Set up automated secret rotation (for production environments)
- âœ… Restricted access to the `.env` file (chmod 600)
- âœ… Documented the key location for your team (in secure internal documentation)

#### 2. Disable Debug Mode

Ensure `debug=False` in production (this is the default)

#### 3. Use HTTPS

Always use SSL/TLS in production to encrypt data in transit

#### 4. Restrict Database Access

Set proper file permissions:
```bash
chmod 600 garden.db
```

#### 5. Keep Dependencies Updated

Regularly update packages to patch security vulnerabilities:
```bash
pip install --upgrade -r requirements.txt
```

### Performance

1. **Use Production WSGI Server**: Never use Flask's built-in server
   - Gunicorn (recommended)
   - uWSGI
   - Waitress

2. **Configure Workers**:
   ```bash
   # Rule of thumb: 2-4 workers per CPU core
   gunicorn --workers 4 --threads 2 app:app
   ```

3. **Enable Caching**:
   - Cache weather data to reduce API calls
   - Use Flask-Caching for response caching

4. **Optimize Database**:
   - Add indexes for frequently queried fields
   - Use connection pooling for high traffic

### Monitoring

1. **Application Logs**:
   ```bash
   sudo journalctl -u planted -f
   ```

2. **Nginx Logs**:
   ```bash
   sudo tail -f /var/log/nginx/error.log
   sudo tail -f /var/log/nginx/access.log
   ```

3. **Health Checks**: Set up monitoring to check application uptime

### Backup

1. **Database Backup**:
   ```bash
   # Create backup script
   #!/bin/bash
   cp /var/www/Planted/garden.db /backups/garden_$(date +%Y%m%d_%H%M%S).db
   ```

2. **Schedule with Cron**:
   ```bash
   # Backup daily at 2 AM
   0 2 * * * /path/to/backup_script.sh
   ```

## Environment Variables Reference

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `OPENWEATHERMAP_API_KEY` | Weather API key | No | `abc123...` |
| `FLASK_SECRET_KEY` | Flask session key | Yes (production) | `hex_string...` |
| `FLASK_ENV` | Environment | No | `production` |
| `DATABASE_PATH` | Database location | No | `/data/garden.db` |

## Multi-User Considerations

Currently, Planted is designed for single-user local use. For multi-user:

1. **Add Authentication**:
   - Flask-Login for user sessions
   - User registration and login

2. **Database Changes**:
   - Add user_id to all tables
   - Migrate to PostgreSQL or MySQL

3. **User Isolation**:
   - Filter all queries by user_id
   - Prevent data leakage between users

## Troubleshooting

### Application Won't Start

1. Check logs: `sudo journalctl -u planted -n 50`
2. Verify Python path in systemd service
3. Check file permissions
4. Verify all dependencies installed

### Database Errors

1. Check file permissions: `ls -l garden.db`
2. Verify database path in configuration
3. Check disk space: `df -h`

### Weather Data Not Loading

1. Verify API key in `.env`
2. Check network connectivity
3. Review weather service logs
4. Ensure API key is activated (can take a few minutes)

### Performance Issues

1. Check server resources: `htop`
2. Increase worker processes
3. Add caching
4. Optimize database queries

## Scaling Considerations

### Vertical Scaling
- Increase server resources (RAM, CPU)
- Optimize application code
- Add caching layers

### Horizontal Scaling
- Use a reverse proxy load balancer
- Share database across instances
- Use Redis for session storage
- Deploy static files to CDN

## Updating the Application

```bash
# On server
cd /var/www/Planted
git pull origin main
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl restart planted
```

## Support

For deployment issues:
- Check [GitHub Issues](https://github.com/zamays/Planted/issues)
- Review Flask documentation
- Consult your hosting provider's docs

---

**Happy Deploying! ðŸš€ðŸŒ±**
